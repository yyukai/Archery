{% extends "base.html" %}

{% block content %}
    <!-- 自定义操作按钮-->
    <div id="toolbar" class="form-inline">
        <div class="form-group ">
            {% if perms.sql.instance_user_edit %}
                <button id="btn_add" type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    添加用户
                </button>
            {% endif %}
        </div>
    </div>
    <!-- 表格-->
    <div class="table-responsive">
        <table id="user-list" data-toggle="table" class="table table-striped table-hover"
               style="table-layout:inherit;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        </table>
    </div>

    <!--更新模态窗-->
    <div class="modal fade" id="addModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                            aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">添加白名单</h4>
                </div>
                <div class="modal-body">
                    <p hidden id="uperrorMsg" class="text-danger" style="color:red"></p> <!-- for error msg-->
                    <form id="addForm" class="form-horizontal  nice-validator n-yellow" novalidate="novalidate">
                        <div class="form-group">
                            <label for="zone" class="col-sm-2 control-label">User<span class="red-fonts">*</span></label>
                            <div class="col-sm-8">
                                <input id="addUser" name="user" placeholder=""
                                       class="form-control" datatype="s2-16" errormsg="格式不正确">
                            </div>
                        </div><!--域-->

                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label for="host" class="col-sm-2 control-label">Host<span class="red-fonts">*</span></label>
                            <div class="col-sm-8">
                                <input id="addHost" name="host" placeholder="" class="form-control">
                            </div>
                        </div><!--comment-->

                        <div class="form-group">
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="addUserBtn">确认</button>
                            </div>
                        </div> <!--button-->
                    </form> <!--form-->
                </div> <!--modal-body-->

            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!--更新模态窗-->
    <div class="modal fade" id="updateModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span
                            aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">更新白名单</h4>
                </div>
                <div class="modal-body">
                    <form id="upForm" class="form-horizontal  nice-validator n-yellow" novalidate="novalidate">
                        <input type="hidden" id="oldUser" name="olduser" class="form-control">
                        <input type="hidden" id="oldHost" name="oldhost" class="form-control">
                        <div class="form-group">
                            <label for="zone" class="col-sm-2 control-label">User<span class="red-fonts">*</span></label>
                            <div class="col-sm-8">
                                <input id="upUser" name="user" placeholder=""
                                       class="form-control" datatype="s2-16" errormsg="格式不正确">
                            </div>
                        </div><!--域-->

                        <div class="hr-line-dashed"></div>
                        <div class="form-group">
                            <label for="host" class="col-sm-2 control-label">Host<span class="red-fonts">*</span></label>
                            <div class="col-sm-8">
                                <input id="upHost" name="host" placeholder="" class="form-control">
                            </div>
                        </div><!--comment-->

                        <div class="form-group">
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="updateUserBtn">确认</button>
                            </div>
                        </div> <!--button-->
                    </form> <!--form-->
                </div> <!--modal-body-->

            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock content %}
{% block js %}
    {% load staticfiles %}
    <script src="{% static 'bootstrap-table/js/bootstrap-table-export.min.js' %}"></script>
    <script src="{% static 'bootstrap-table/js/tableExport.min.js' %}"></script>
    <script>
        //获取列表
        function userlist() {
            //采取异步请求
            //初始化table
            $('#user-list').bootstrapTable('destroy').bootstrapTable({
                escape: true,
                method: 'post',
                contentType: "application/x-www-form-urlencoded",
                url: "/instance/users/",
                striped: true,                      //是否显示行间隔色
                cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: true,                   //是否显示分页（*）
                sortable: true,                     //是否启用排序
                sortOrder: "asc",                   //排序方式
                sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1,                      //初始化加载第一页，默认第一页,并记录
                pageSize: 14,                     //每页的记录行数（*）
                pageList: [20, 30, 50, 100],       //可供选择的每页的行数（*）
                showExport: true,                   //是否显示导出按钮
                exportOptions: {
                    fileName: 'instance'  //文件名称设置
                },
                search: true,                      //是否显示表格搜索
                strictSearch: false,                //是否全匹配搜索
                showColumns: true,                  //是否显示所有的列（选择显示的列）
                showRefresh: true,                  //是否显示刷新按钮
                minimumCountColumns: 2,             //最少允许的列数
                clickToSelect: true,                //是否启用点击选中行
                uniqueId: "id",                     //每一行的唯一标识，一般为主键列
                showToggle: true,                   //是否显示详细视图和列表视图的切换按钮
                cardView: false,                    //是否显示详细视图
                detailView: false,                  //是否显示父子表
                locale: 'zh-CN',                    //本地化
                toolbar: "#toolbar",               //指明自定义的toolbar
                queryParamsType: 'limit',
                //请求服务数据时所传参数
                queryParams:
                    function (params) {
                        return {
                            search: params.search,
                            instance_id: "{{ instance_id }}"
                        }
                    },
                columns: [
                    {
                        title: 'User@Host',
                        field: 'user'
                    }, {
                        title: 'privileges',
                        field: 'privileges',
                        formatter: function (value, row, index) {
                            var priv = '';
                            for (var i = 0; i < value.length; i++) {
                                priv = priv + value[i] + ';</br>'
                            }
                            return priv
                        }
                    }, {
                        title: '操作',
                        field: '',
                        formatter: function (value, row, index) {
                            {% if perms.sql.instance_user_edit %}
                                return "<button class=\"btn btn-warning btn-xs\" onclick=\"edit_user('"+row.user+"','"+row.host+"')\">修改</button>"
                                + "<button class=\"btn btn-danger btn-xs\" onclick=\"del_user('" + row.user+"','"+row.host+"')\">删除</button>"
                            {% endif %}
                        }
                }],
                onLoadSuccess: function () {
                },
                onLoadError: function () {
                    alert("数据加载失败！请检查接口返回信息和错误日志！");
                },
                onSearch: function (e) {
                    //传搜索参数给服务器
                    queryParams(e)
                }
            });

        }

        //初始化数据
        $(document).ready(function () {
            userlist()
        });
        $("#btn_add").on('click',function(){
            $('#addModal').modal({});
            $("#modal_btn").unbind("click").click(function(){
                var user = document.getElementById("addUser").value;
                var host = document.getElementById("addHost").value;
                $.ajax({
                    type: "POST",
                    url: "/ip_white/add/" + {{ instance_id }},
                    data: {'user': user, 'host': host},
                    success: function (data) {
                        alert(data);
                        window.location.reload();
                    }
                });
            });
        });
        function edit_user(user, host){
            $('#oldUser').val(user);
            $('#upUser').val(user);
            $('#oldHost').val(host);
            $('#upHost').val(host);
            $('#updateModal').modal({});
            $("#updateUserBtn").unbind("click").click(function(){
                $.ajax({
                    type: "POST",
                    url: "/ip_white/edit/" + {{ instance_id }},
                    data: $('#upForm').serialize(),
                    success: function (data) {
                        alert(data);
                        window.location.reload();
                    }
                });
            });
        }
        function del_user(user, host) {
            if (confirm("确定删除")) {
                $.ajax({
                    url: "/ip_white/delete/" + {{ instance_id }},
                    type: "POST",
                    data: {'user': user, 'host': host},
                    success: function (res) {
                        console.log(res);
                        if (res.code == 0) {
                            alert(res);
                            window.location.reload();
                        } else {
                            alert(res);
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}
